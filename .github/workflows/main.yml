name: TSun RDP Access (6 Hours)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Download Ngrok üì¶
        run: |
          Invoke-WebRequest https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-windows-amd64.zip -OutFile ngrok.zip
          Expand-Archive ngrok.zip -DestinationPath ngrok
          Remove-Item ngrok.zip

      - name: Authenticate Ngrok üîê
        run: .\ngrok\ngrok.exe authtoken $Env:NGROK_AUTH_TOKEN
        env:
          NGROK_AUTH_TOKEN: ${{ secrets.NGROK_AUTH_TOKEN }}

      - name: Enable Remote Desktop üöÄ
        run: |
          Set-ItemProperty 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name fDenyTSConnections -Value 0
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
          Set-ItemProperty 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name UserAuthentication -Value 1

      - name: Create local user üßë‚Äçüíª
        run: |
          if (-not (Get-LocalUser -Name "saeedxdie" -ErrorAction SilentlyContinue)) {
            New-LocalUser -Name "saeedxdie" -Password (ConvertTo-SecureString "S@eedxdie1" -AsPlainText -Force)
          }
          Add-LocalGroupMember -Group Administrators -Member saeedxdie

      # Ngrok v3 syntax: `ngrok.exe tcp 3389 --log=stdout` works if you
      # start it directly (no Start-Process), so the API starts reliably.
      - name: Start Ngrok Tunnel üîó
        run: |
          Start-Job { .\ngrok\ngrok.exe tcp 3389 --log=stdout --log-level=info } | Out-Null
          Write-Host "Waiting for Ngrok to start..."
          Start-Sleep -Seconds 15

      - name: Fetch tunnel info üåç
        shell: pwsh
        run: |
          $max = 30; $url = $null
          for ($i=1; $i -le $max; $i++) {
            try {
              $resp = Invoke-RestMethod -Uri "http://127.0.0.1:4040/api/tunnels"
              if ($resp.tunnels.Count -gt 0) {
                $url = $resp.tunnels[0].public_url
                break
              }
            } catch {}
            Write-Host "Ngrok not ready yet ($i/$max)..."
            Start-Sleep -Seconds 3
          }

          if ($null -eq $url) {
            Write-Error "Ngrok tunnel still not ready after $max attempts. Printing log:"
            Get-Content ngrok.log -Tail 40 -ErrorAction SilentlyContinue
            exit 1
          }

          Write-Host "======================================"
          Write-Host "‚úÖ RDP Tunnel Ready!"
          Write-Host "Address: $url"
          Write-Host "Username: saeedxdie"
          Write-Host "Password: S@eedxdie1"
          Write-Host "======================================"

      - name: Keep alive 6 hours üïì
        run: |
          echo "Keeping RDP active for 6 hours..."
          timeout /t 21600
